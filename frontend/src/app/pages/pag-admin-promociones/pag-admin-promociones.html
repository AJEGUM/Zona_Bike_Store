<div class="mx-20">
  <div class="flex items-center">
    <h1 class="text-xl my-10">Gestión de promociones</h1>

    <button (click)="abrirModalCrear()"
            class="ml-auto text-sm bg-[#0B1120] text-white px-4 py-2 font-semibold cursor-pointer rounded-lg flex items-center gap-2 hover:bg-[#141c33] transition">
      <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5" viewBox="0 -960 960 960" fill="#e3e3e3">
        <path d="M440-440H200v-80h240v-240h80v240h240v80H520v240h-80v-240Z"/>
      </svg>
      Nueva promoción
    </button>
  </div>

  <!-- TABLA -->
  <div class="overflow-x-auto">
    <table class="w-full text-sm text-left border border-gray-300 rounded-lg border-separate border-spacing-0">
      <thead>
        <tr>
          <th class="px-4 py-3 font-semibold border-b border-gray-300 rounded-tl-lg">Título</th>
          <th class="px-4 py-3 font-semibold border-b border-gray-300">Descripción</th>
          <th class="px-4 py-3 font-semibold border-b border-gray-300">Fecha Inicio</th>
          <th class="px-4 py-3 font-semibold border-b border-gray-300">Fecha Fin</th>
          <th class="px-4 py-3 font-semibold border-b border-gray-300">Estado</th>
          <th class="px-4 py-3 text-center font-semibold border-b border-gray-300 rounded-tr-lg">Acciones</th>
        </tr>
      </thead>

      <tbody class="bg-white divide-y divide-gray-200">
        <tr *ngFor="let promo of promociones" class="hover:bg-gray-50 transition">
          <td class="px-4 py-3">{{ promo.titulo }}</td>
          <td class="px-4 py-3">{{ promo.descripcion }}</td>
          <td class="px-4 py-3">{{ promo.fecha_inicio | date:'dd-MM-yyyy' }}</td>
          <td class="px-4 py-3">{{ promo.fecha_fin | date:'dd-MM-yyyy' }}</td>


          <td class="px-4 py-3">
            <span class="px-2 py-1 rounded-md text-xs font-semibold"
                  [ngClass]="{
                    'bg-green-100 text-green-700': promo.estado === 'activa',
                    'bg-red-100 text-red-700': promo.estado === 'inactiva'
                  }">
              {{ promo.estado }}
            </span>
          </td>

          <td class="px-4 py-3 text-center">
            <button (click)="abrirModalEditar(promo)" class="cursor-pointer px-5" title="Editar">
              <svg xmlns="http://www.w3.org/2000/svg" height="24" viewBox="0 -960 960 960" width="24">
                <path d="M205-205h53l392-391.5-53.5-53.5L205-257.5v52.5Zm-75 75v-159l520-519.5q10.98-10.28 24.24-15.89Q687.5-830 702.47-830t29 5.75q14.03 5.75 25.03 16.75l52 52.5q11 10.5 16.25 24.25t5.25 28.02q0 15.23-5.14 28.67-5.14 13.44-16.36 24.56L289-130H130Z"/>
              </svg>
            </button>

            <button (click)="eliminar(promo.id_promocion)" class="cursor-pointer">
              <svg xmlns="http://www.w3.org/2000/svg" height="24" viewBox="0 -960 960 960" width="24" fill="#EA3323">
                <path d="M283-130q-30.94 0-52.97-22.03Q208-174.06 208-205v-512h-39v-75h193v-38h237v38h193v75h-39v512q0 30.94-22.03 52.97Q708.94-130 678-130H283Zm395-587H283v512h395v-512Z"/>
              </svg>
            </button>
          </td>
        </tr>
      </tbody>
    </table>
  </div>
</div>

<div *ngIf="modalAbierto" class="fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4">
  <div class="bg-white w-full max-w-5xl rounded-xl shadow-lg p-6 relative max-h-[90vh] overflow-y-auto">

    <button (click)="cerrarModal()" class="absolute top-3 right-3 text-gray-500 hover:text-black">✕</button>

    <h2 class="text-2xl font-semibold mb-6">
      {{ promoEditando ? 'Editar promoción' : 'Nueva promoción' }}
    </h2>

    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">

      <!-- PREVIEW -->
      <div class="rounded-xl border shadow-sm p-4 bg-white">

        <!-- PREVIEW TIPO BANNER -->
        <div class="relative rounded-xl overflow-hidden bg-gray-100 flex items-center justify-center h-44 lg:h-56">

          <!-- Preview imagen -->
          <img *ngIf="imagenBase64; else imgUrl" [src]="imagenBase64" class="w-full h-full object-cover" />

          <ng-template #imgUrl>
            <img *ngIf="form.imagen && typeof form.imagen === 'string'" 
                [src]="form.imagen" class="w-full h-full object-cover" />
          </ng-template>

          <div *ngIf="form.titulo || form.descripcion"
              class="absolute inset-0 flex flex-col text-white font-semibold p-4"
              [ngClass]="{
                  'justify-start text-left': form.posicion_texto === 'arriba',
                  'justify-center text-center': form.posicion_texto === 'centro',
                  'justify-end text-left pb-4': form.posicion_texto === 'abajo'
              }">

            <h3 class="text-lg drop-shadow-md">{{ form.titulo }}</h3>
            <p class="text-sm drop-shadow">{{ form.descripcion }}</p>
          </div>

        </div>

      </div>

      <!-- FORMULARIO -->
      <form class="space-y-4" (ngSubmit)="guardar()">

        <div>
          <label class="block font-medium">Título</label>
          <input type="text" [(ngModel)]="form.titulo" name="titulo"
                class="w-full border rounded-lg px-3 py-2" required />
        </div>

        <div>
          <label class="block font-medium">Descripción</label>
          <textarea [(ngModel)]="form.descripcion" name="descripcion"
                    class="w-full border rounded-lg px-3 py-2 min-h-[80px]"></textarea>
        </div>

        <div>
          <label class="block font-medium">Imagen</label>
          <input type="file" accept="image/*" (change)="imagenSeleccionada($event)"
                class="w-full border rounded-lg px-3 py-2">
        </div>

        <div>
          <label class="block font-medium">Fecha inicio</label>
          <input type="date" [(ngModel)]="form.fecha_inicio" name="fecha_inicio"
                 class="w-full border rounded-lg px-3 py-2" required />
        </div>

        <div>
          <label class="block font-medium">Fecha fin</label>
          <input type="date" [(ngModel)]="form.fecha_fin" name="fecha_fin"
                 class="w-full border rounded-lg px-3 py-2" required />
        </div>

        <div>
          <label class="block font-medium">Estado</label>
          <select [(ngModel)]="form.estado" name="estado"
                  class="w-full border rounded-lg px-3 py-2">
            <option value="activa">Activa</option>
            <option value="inactiva">Inactiva</option>
          </select>
        </div>

        <div>
          <label class="block font-medium">Posición del texto</label>
          <select [(ngModel)]="form.posicion_texto" name="posicion_texto"
                  class="w-full border rounded-lg px-3 py-2">
            <option value="arriba">Arriba</option>
            <option value="centro">Centro</option>
            <option value="abajo">Abajo</option>
          </select>
        </div>


        <div class="flex justify-end gap-3 pt-4">
          <button type="button" (click)="cerrarModal()"
                  class="px-4 py-2 border rounded-lg hover:bg-gray-100">Cancelar</button>

          <button type="submit"
                  class="px-4 py-2 bg-[#0B1120] text-white rounded-lg hover:bg-[#141c33]">
            {{ promoEditando ? 'Actualizar' : 'Registrar' }}
          </button>
        </div>

      </form>

    </div>
  </div>
</div>
