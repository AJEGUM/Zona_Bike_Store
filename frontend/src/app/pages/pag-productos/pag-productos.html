<app-nav-bar
  (searchChanged)="filtrarProductos($event)"
  [mensajeExterno]="mensajeToast">
</app-nav-bar>

<div [class.blur-xs]="modalAbierto"
     class="max-w-[1400px] mx-auto px-4 sm:px-6 lg:px-10 pt-10">

  <h2 class="text-white text-2xl font-semibold mb-8">Nuestro CatÃ¡logo</h2>

    <!-- BOTÃ“N DE FILTROS SOLO EN MÃ“VIL -->
  <div class="flex justify-end mb-4 lg:hidden">
    <button 
      (click)="modalFiltrosAbierto = true"
      class="flex items-center gap-2 bg-gray-200 px-4 py-2 rounded-full shadow text-gray-700 active:scale-95 transition">
      
      <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" 
              d="M3 4h18M6 12h12M10 20h4" />
      </svg>

      Filtros
      <span *ngIf="contarFiltrosActivos() > 0" class="bg-black text-white px-2 py-0.5 rounded-full text-sm">
        {{ contarFiltrosActivos() }}
      </span>
    </button>
  </div>


  <!-- GRID PRINCIPAL -->
  <div class="grid grid-cols-1 lg:grid-cols-4 gap-8">

    <!-- ===================== -->
    <!-- FILTROS LADO IZQUIERDO -->
    <!-- ===================== -->
    <div class="lg:col-span-1 hidden lg:block">

      <!-- sticky corregido -->
      <div class="sticky top-20">

        <div class="bg-[#242938] shadow-md rounded-xl p-5 border border-gray-600">

          <!-- HEADER FILTRO -->
          <div class="flex items-center justify-between mb-4">
            <h3 class="text-lg text-white font-semibold">Filtros</h3>
            <button class="text-sm text-white hover:underline"
                    (click)="limpiarFiltros()">
              Limpiar
            </button>
          </div>

          <!-- CATEGORÃAS -->
          <div class="mb-6">
            <h3 class="font-medium text-white mb-2">CategorÃ­as</h3>

            <div class="space-y-2">
              <label *ngFor="let cat of categorias"
                     class="text-white flex items-center gap-2 cursor-pointer">

                    <input 
                      type="checkbox"
                      class="w-4 h-4"
                      [checked]="categoriasSeleccionadas.includes(cat.id_categoria)"
                      (change)="alternarCategoria(cat.id_categoria)"
                    >
                    <span>{{ cat.nombre }}</span>
              </label>
            </div>
          </div>

          <!-- RANGO DE PRECIO (SOLO 1 SLIDER) -->
          <div class="mb-6">
            <p class="text-white font-medium mb-2">Precio mÃ¡ximo</p>

            <!-- SLIDER ÃšNICO -->
            <input type="range"
                   min="0"
                   max="25000000"
                   [(ngModel)]="precioMax"
                   (input)="cambiarPrecio()"
                   class="w-full accent-white" />

            <div class="flex justify-between text-sm text-white mt-2">
              <span>Desde: {{ precioMin | currency:'COP' }}</span>
              <span>Hasta: {{ precioMax | currency:'COP' }}</span>
            </div>
          </div>

          <!-- DISPONIBILIDAD -->
          <div class="mb-4">
            <p class="text-white font-medium mb-2">Disponibilidad</p>

            <label class="text-white flex items-center gap-2 cursor-pointer">
              <input 
                type="checkbox"
                class="w-4 h-4 rounded border-gray-300"
                [(ngModel)]="soloDisponibles"
                (change)="cambiarDisponibilidad()"
              >
              <span>Solo productos disponibles</span>
            </label>
          </div>

        </div>
      </div>
    </div>

    <!-- ======================== -->
    <!-- PRODUCTOS -->
    <!-- ======================== -->
    <div class="lg:col-span-3">

      <div *ngIf="productosFiltrados.length > 0; else noProductos"
           class="grid grid-cols-1 sm:grid-cols-2 gap-5">

        <div *ngFor="let p of productosFiltrados"
             (click)="abrirModalProducto(p)"
             class="rounded-xl overflow-hidden cursor-pointer shadow border border-gray-600 bg-[#242938] flex flex-col group relative">

          <!-- IMAGEN -->
          <div class="h-60 sm:h-64 md:h-72 bg-gray-100 overflow-hidden relative">
            <img [src]="obtenerImagen(p)"
                 alt="{{ p.nombre }}"
                 class="w-full h-full object-cover transform transition-transform duration-300 group-hover:scale-110" />

            <div class="absolute inset-0 flex items-center justify-center opacity-0 group-hover:opacity-100 transition-opacity duration-300 bg-black/30">
              <svg xmlns="http://www.w3.org/2000/svg" class="w-10 h-10 text-white" fill="currentColor" viewBox="0 0 24 24">
                <path d="M12 5c-7.633 0-11 7-11 7s3.367 7 11 7 11-7 11-7-3.367-7-11-7zm0 12c-2.761 0-5-2.239-5-5s2.239-5 5-5 5 2.239 5 5-2.239 5-5 5zm0-8.5c-1.93 0-3.5 1.57-3.5 3.5s1.57 3.5 3.5 3.5 3.5-1.57 3.5-3.5-1.57-3.5-3.5-3.5z" />
              </svg>
            </div>
          </div>

          <!-- INFO -->
          <div class="p-3 flex flex-col">
            <p class="text-[#6E5FD9] text-sm">{{ p.categoria?.nombre }}</p>
            <h3 class="text-lg text-white mt-1 font-semibold">{{ p.nombre }}</h3>
            <p class="text-white text-lg mt-2 font-semibold">{{ p.precio_venta_formateado }} COP</p>
            <p class="text-sm text-white mt-1">Stock: {{ p.stock || 0 }}</p>

            <div class="mt-4">
              <button *ngIf="p.estado === 'activo'"
                      (click)="agregarAlCarrito(p, 1); $event.stopPropagation()"
                      class="bg-[#442ED9] text-white px-4 py-2 rounded-lg hover:bg-gray-900 w-full">
                Agregar al carrito ðŸ›’
              </button>

              <div *ngIf="p.estado !== 'activo'"
                   class="w-full py-2 rounded-lg bg-gray-300 text-center text-gray-700 flex items-center justify-center gap-2 cursor-not-allowed">
                Producto no disponible
              </div>

            </div>
          </div>
        </div>

      </div>

      <ng-template #noProductos>
        <div class="text-center text-gray-500 py-20 text-lg font-semibold">
          No se encontraron productos
        </div>
      </ng-template>

    </div>
  </div>
</div>


<div *ngIf="modalAbierto" 
     class="fixed inset-0 bg-black/60 z-50 flex items-center justify-center p-4">
  
  <!-- Fondo clickeable para cerrar -->
  <div class="absolute inset-0" (click)="cerrarModalProducto()"></div>

  <!-- Contenedor del modal -->
  <div class="relative bg-[#242938] rounded-2xl shadow-2xl w-full max-w-4xl max-h-[90vh] overflow-hidden animate-fade-in z-10 flex flex-col">
    
    <!-- Header -->
    <div class="flex justify-between items-center px-6 py-4 border-b">
      <button (click)="cerrarModalProducto()"
              class="text-gray-400 hover:text-gray-700 text-2xl leading-none transition">
        &times;
      </button>
    </div>

    <!-- Contenido con scroll interno -->
    <div class="grid md:grid-cols-2 gap-0 flex-1 overflow-y-auto">
      
      <!-- Imagen -->
      <div class="bg-[#1A1D29] flex items-center justify-center p-6">
        <img [src]="obtenerImagen(modalProducto)" [alt]="modalProducto.nombre"
             class="w-full max-h-[450px] object-contain rounded-xl" />
      </div>

      <!-- InformaciÃ³n -->
      <div class="p-6 flex flex-col justify-between">
        <div>
          <h2 class="text-4xl text-center font-semibold text-gray-100 truncate">
            {{ modalProducto.nombre }}
          </h2>
          <p class="text-sm text-gray-300 mb-1 text-center">{{ modalProducto.categoria?.nombre }}</p>

          <p class="text-3xl font-semibold text-gray-100 mb-4">{{ modalProducto.precio_venta_formateado }} COP</p>          

          
          
          <h3 class="text-base font-semibold text-gray-300 mb-2">DescripciÃ³n:</h3>
          <p class="text-gray-300 leading-relaxed mb-6 whitespace-pre-line">{{ modalProducto.descripcion }}</p>
          
          <div class="flex items-center gap-2 mb-3">
            <span *ngIf="modalProducto.estado === 'activo'" 
                  class="bg-green-100 text-green-700 text-xs font-medium px-2 py-1 rounded">
              Disponible
            </span>
            <span *ngIf="modalProducto.estado !== 'activo'" 
                  class="bg-red-100 text-red-600 text-xs font-medium px-2 py-1 rounded">
              No disponible
            </span>
          </div>

          <div class="border-t pt-4 space-y-2 text-sm text-gray-300">
            <p>Stock disponible: <span class="font-medium">{{ modalProducto.stock || 0 }} unidades</span></p>
            <p>CategorÃ­a: <span class="font-medium">{{ modalProducto.categoria?.nombre }}</span></p>
          </div>
        </div>

        <!-- CONTROLES -->
        <div class="mt-6">
          <div class="flex items-center gap-3 mb-4" *ngIf="modalProducto.estado === 'activo'">
            <span class="text-sm text-gray-100 font-medium">Cantidad</span>
            <div class="flex items-center border rounded-lg">
              <button class="px-3 py-1 text-gray-100 rounded-l-lg" (click)="disminuirCantidad()">âˆ’</button>
              <input type="number"
                    [(ngModel)]="cantidad"
                    min="1"
                    class="w-12 text-center text-gray-100"
                    (input)="cantidad = +$event.target.value" />
              <button class="px-3 py-1 text-gray-100 rounded-r-lg" (click)="aumentarCantidad()">+</button>
            </div>
          </div>

          <button *ngIf="modalProducto.estado === 'activo'" 
                  (click)="agregarAlCarrito(modalProducto, cantidad); cerrarModalProducto()"
                  class="w-full bg-[#442ED9] text-white py-3 rounded-lg hover:bg-gray-900 font-medium flex items-center justify-center gap-2 transition">
            ðŸ›’ AÃ±adir al carrito
          </button>

          <div *ngIf="modalProducto.estado !== 'activo'"
               class="w-full py-3 bg-[#2B3548] text-center text-gray-300 rounded-lg flex items-center justify-center gap-2">
            ðŸš« Producto no disponible
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Filtro modal responsive -->
 <!-- MODAL DE FILTROS (MÃ“VIL) -->
<div *ngIf="modalFiltrosAbierto" 
     class="fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4 lg:hidden">

  <!-- Fondo clickeable -->
  <div class="absolute inset-0" (click)="modalFiltrosAbierto = false"></div>

  <!-- Panel -->
  <div class="relative bg-white w-full max-w-md rounded-xl shadow-lg p-5 z-10 animate-fade-in">

    <div class="flex justify-between items-center mb-4">
      <h3 class="text-lg font-semibold">Filtros</h3>
      <button (click)="modalFiltrosAbierto = false" class="text-xl">&times;</button>
    </div>

    <!-- CATEGORÃAS -->
    <div class="mb-6">
      <h4 class="font-medium mb-2">CategorÃ­as</h4>

      <div class="space-y-2">
        <label *ngFor="let cat of categorias" class="flex items-center gap-2">
          <input 
            type="checkbox" 
            [checked]="categoriasSeleccionadas.includes(cat.id_categoria)"
            (change)="alternarCategoria(cat.id_categoria)"
          >
          {{ cat.nombre }}
        </label>
      </div>
    </div>

    <!-- PRECIO -->
    <div class="mb-6">
      <h4 class="font-medium mb-2">Precio mÃ¡ximo</h4>

      <input type="range" min="0" max="25000000" [(ngModel)]="precioMax"
             (input)="cambiarPrecio()" class="w-full accent-black"/>

      <div class="flex justify-between text-sm text-gray-600 mt-2">
        <span>{{ precioMin | currency:'COP' }}</span>
        <span>{{ precioMax | currency:'COP' }}</span>
      </div>
    </div>

    <!-- DISPONIBILIDAD -->
    <div class="mb-6">
      <label class="flex items-center gap-2">
        <input type="checkbox" [(ngModel)]="soloDisponibles" (change)="cambiarDisponibilidad()">
        Solo productos disponibles
      </label>
    </div>

    <!-- BOTONES -->
    <div class="flex justify-end gap-3 pt-2 border-t">
      <button (click)="limpiarFiltros()" class="text-gray-600 hover:underline">
        Limpiar
      </button>

      <button (click)="modalFiltrosAbierto = false"
              class="bg-black text-white px-4 py-2 rounded-lg">
        Aplicar
      </button>
    </div>

  </div>
</div>
