<div class="px-4 sm:px-10 lg:px-20">

  <!-- ENCABEZADO: Título + Botón -->
    <div class="flex items-center mt-6 mb-4">
    <h1 class="text-lg sm:text-xl text-white font-semibold">
      Gestión de productos
    </h1>

    <!-- Empuja todo lo que viene DESPUÉS del título hacia la derecha -->
    <div class="ml-auto flex items-center gap-3">

      <button
        (click)="abrirModalCategorias()"
        class="text-xs sm:text-sm bg-white text-black px-3 sm:px-4 py-2
              font-medium rounded-lg flex items-center gap-2 shadow hover:bg-gray-100">

        <svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4 sm:w-5 sm:h-5"
          viewBox="0 -960 960 960" fill="currentColor">
          <path d="M440-440H200v-80h240v-240h80v240h240v80H520v240h-80v-240Z"/>
        </svg>

        Nueva categoría
      </button>

      <button
        (click)="abrirModalMarcas()"
        class="text-xs sm:text-sm bg-white text-black px-3 sm:px-4 py-2
              font-medium rounded-lg flex items-center gap-2 shadow hover:bg-gray-100">

        <svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4 sm:w-5 sm:h-5"
          viewBox="0 -960 960 960" fill="currentColor">
          <path d="M440-440H200v-80h240v-240h80v240h240v80H520v240h-80v-240Z"/>
        </svg>

        Nueva marca
      </button>

      <button
        (click)="abrirModalCrear()"
        class="text-xs sm:text-sm bg-white text-black px-3 sm:px-4 py-2
              font-medium rounded-lg flex items-center gap-2 shadow hover:bg-gray-100">

        <svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4 sm:w-5 sm:h-5"
          viewBox="0 -960 960 960" fill="currentColor">
          <path d="M440-440H200v-80h240v-240h80v240h240v80H520v240h-80v-240Z"/>
        </svg>

        Nuevo producto
      </button>

    </div>
  </div>


  <!-- TABLA SCROLLABLE Y BONITA -->
  <div class="overflow-x-auto rounded-xl shadow">
    <table class="min-w-[700px] w-full text-sm text-left bg-white rounded-xl">
      <thead>
        <tr class="bg-white border-b border-gray-300">
          <th class="px-4 py-3 font-semibold">Producto</th>
          <th class="px-4 py-3 font-semibold">Categoría</th>
          <th class="px-4 py-3 font-semibold">Marca</th>
          <th class="px-4 py-3 font-semibold">Precio</th>
          <th class="px-4 py-3 font-semibold">Stock</th>
          <th class="px-4 py-3 font-semibold">Estado</th>
          <th class="px-4 py-3 font-semibold text-center">Acciones</th>
        </tr>
      </thead>

      <tbody class="divide-y divide-gray-200">
        <tr *ngFor="let p of productos" class="hover:bg-gray-50">
          <td class="px-4 py-3">{{ p.nombre }}</td>
          <td class="px-4 py-3">{{ p.categoria?.nombre || '-' }}</td>
          <td class="px-4 py-3">{{ p.marca?.nombre || '-' }}</td>
          <td class="px-4 py-3">${{ p.precio_venta }}</td>
          <td class="px-4 py-3 text-center">
            <span
              class="px-3 py-1 rounded-md text-xs font-semibold flex items-center justify-center gap-1"
              [ngClass]="{
                'bg-green-100 text-green-700': (p.stock ?? 0) >= 20,
                'bg-yellow-100 text-yellow-700': (p.stock ?? 0) >= 6 && (p.stock ?? 0) < 20,
                'bg-red-100 text-red-700': (p.stock ?? 0) <= 5
              }"
            >
              <ng-container *ngIf="(p.stock ?? 0) <= 5">
                <!-- Ícono alerta roja -->
                <svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4 text-red-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                    d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
                </svg>
              </ng-container>

              {{ p.stock }}
            </span>
          </td>


          <td class="px-4 py-3">
            <span
              class="px-2 py-1 rounded-md text-xs font-semibold"
              [ngClass]="{
                'bg-green-100 text-green-700': p.estado === 'activo',
                'bg-red-100 text-red-700': p.estado === 'inactivo'
              }"
            >
              {{ p.estado }}
            </span>
          </td>
          <td class="px-4 py-3 text-center">
            <button (click)="abrirModalEditar(p)" class="px-5 cursor-pointer" title="Editar">
              <svg xmlns="http://www.w3.org/2000/svg" height="24px" viewBox="0 -960 960 960" width="24px"
                fill="#000000">
                <path
                  d="M205-205h53l392-391.5-53.5-53.5L205-257.5v52.5Zm-75 75v-159l520-519.5q10.98-10.28 24.24-15.89Q687.5-830 702.47-830t29 5.75q14.03 5.75 25.03 16.75l52 52.5q11 10.5 16.25 24.25t5.25 28.02q0 15.23-5.14 28.67-5.14 13.44-16.36 24.56L289-130H130Zm625-572.5L702.5-755l52.5 52.5ZM623-623l-26.5-27 53.5 53.5-27-26.5Z" />
              </svg>
            </button>

            <button (click)="eliminar(p.id_producto!)" class="cursor-pointer">
              <svg xmlns="http://www.w3.org/2000/svg" height="24px" viewBox="0 -960 960 960" width="24px"
                fill="#EA3323">
                <path
                  d="M283-130q-30.94 0-52.97-22.03Q208-174.06 208-205v-512h-39v-75h193v-38h237v38h193v75h-39v512q0 30.94-22.03 52.97Q708.94-130 678-130H283Zm395-587H283v512h395v-512ZM365-283.5h75v-355h-75v355Zm156 0h75v-355h-75v355ZM283-717v512-512Z" />
              </svg>
            </button>
          </td>
        </tr>
      </tbody>
    </table>
  </div>
</div>


<!-- Modal: Crear / Editar Producto -->
<div *ngIf="modalAbierto" class="fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4">

  <div class="bg-white w-full max-w-5xl rounded-xl shadow-lg p-6 relative 
              max-h-[90vh] overflow-y-auto">

    <!-- Botón cerrar -->
    <button (click)="cerrarModal()" class="absolute top-3 right-3 text-gray-500 hover:text-black">
      ✕
    </button>

    <h2 class="text-2xl font-semibold mb-6">
      {{ productoEditando ? 'Editar producto' : 'Nuevo producto' }}
    </h2>

    <!-- CONTENIDO HORIZONTAL -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">

      <!-- PREVIEW DEL PRODUCTO -->
      <div class="rounded-xl border shadow-sm p-4 bg-white">

      <div class="rounded-xl overflow-hidden bg-gray-100 flex items-center justify-center h-72">
        <img *ngIf="imagenBase64 || formProducto.get('imagen')?.value"
            [src]="imagenBase64 
                    ? ('data:image/jpeg;base64,' + imagenBase64) 
                    : formProducto.get('imagen')?.value"
            class="w-full h-full object-cover" />

        <span *ngIf="!formProducto.get('imagen')?.value && !imagenBase64"
              class="text-gray-400 text-sm">
          Vista previa
        </span>
      </div>

      <div class="mt-4 text-sm text-gray-500">
        {{ selectedCategoryName() || 'Categoría' }}
      </div>

      <h3 class="text-lg font-semibold">
        {{ formProducto.get('nombre')?.value }}
      </h3>

      <div class="flex justify-between items-center mt-2">
        <p class="font-semibold text-gray-900 text-lg">
          {{ formProducto.get('precio_venta')?.value 
              ? ('$' + formProducto.get('precio_venta')?.value)
              : 'Precio' }}
        </p>

        <span class="text-gray-500 text-sm">
          Stock: {{ formProducto.get('stock')?.value || 0 }}
        </span>
      </div>

    </div>


      <!-- FORMULARIO REACTIVO -->
      <form [formGroup]="formProducto" (ngSubmit)="guardarProducto()" class="space-y-4">

        <!-- Nombre -->
        <div>
          <label class="block font-medium">Nombre</label>
          <input type="text" formControlName="nombre" 
                (keypress)="soloLetrasNumeros($event)"
                class="w-full border rounded-lg px-3 py-2" />
          <small class="text-red-500 text-sm" *ngIf="formProducto.get('nombre')?.invalid && formProducto.get('nombre')?.touched">
            Nombre obligatorio y solo letras/números
          </small>
        </div>

        <!-- Descripción -->
        <div>
          <label class="block font-medium">Descripción</label>
          <textarea formControlName="descripcion"
                    class="w-full border rounded-lg px-3 py-2 min-h-[80px]" (keypress)="soloLetrasNumeros($event)"></textarea>
          <small class="text-red-500 text-sm" *ngIf="formProducto.get('descripcion')?.invalid && formProducto.get('descripcion')?.touched">
            Descripción obligatoria
          </small>
        </div>

        <!-- Imagen -->
        <div>
          <label class="block font-medium">Imagen (Archivo)</label>
          <input type="file"
                accept="image/*"
                (change)="onFileSelected($event)"
                class="w-full border rounded-lg px-3 py-2" />
          <small class="text-gray-500">
            Si editas y no seleccionas una imagen nueva, se mantendrá la actual.
          </small>
        </div>

        <!-- Precio -->
        <div>
          <label class="block font-medium">Precio</label>
          <input type="number" formControlName="precio_venta"
                 class="w-full border rounded-lg px-3 py-2" />
          <small class="text-red-500 text-sm" *ngIf="formProducto.get('precio_venta')?.invalid && formProducto.get('precio_venta')?.touched">
            Precio obligatorio y mayor o igual a 0
          </small>
        </div>

        <!-- Stock -->
        <div>
          <label class="block font-medium">Stock</label>
          <input type="number" formControlName="stock"
                 class="w-full border rounded-lg px-3 py-2" />
          <small class="text-red-500 text-sm" *ngIf="formProducto.get('stock')?.invalid && formProducto.get('stock')?.touched">
            Stock obligatorio y mayor o igual a 0
          </small>
        </div>

        <!-- Categoría -->
        <div>
          <label class="block font-medium">Categoría</label>
          <select formControlName="id_categoria"
                  class="w-full border rounded-lg px-3 py-2">
            <option *ngFor="let c of categorias" [value]="c.id_categoria">
              {{ c.nombre }}
            </option>
          </select>
          <small class="text-red-500 text-sm" *ngIf="formProducto.get('id_categoria')?.invalid && formProducto.get('id_categoria')?.touched">
            Selecciona una categoría
          </small>
        </div>

        <!-- Marca -->
        <div>
          <label class="block font-medium">Marca</label>
          <select formControlName="id_marca">
            <option value="">Seleccione una marca</option>
            <option *ngFor="let m of marcas" [value]="m.id_marca">
              {{ m.nombre }}
            </option>
          </select>
          <small class="text-red-500 text-sm" *ngIf="formProducto.get('id_marca')?.invalid && formProducto.get('id_marca')?.touched">
            Selecciona una marca
          </small>
        </div>

        <!-- Estado -->
        <div>
          <label class="block font-medium">Estado</label>
          <select formControlName="estado"
                  class="w-full border rounded-lg px-3 py-2">
            <option value="activo">Activo</option>
            <option value="inactivo">Inactivo</option>
          </select>
        </div>

        <!-- Botones -->
        <div class="flex justify-end gap-3 pt-4">
          <button type="button" (click)="cerrarModal()"
                  class="px-4 py-2 border rounded-lg hover:bg-gray-100">
            Cancelar
          </button>
          <button type="submit"
                  class="px-4 py-2 bg-[#0B1120] text-white rounded-lg hover:bg-[#141c33]">
            {{ productoEditando ? 'Actualizar' : 'Registrar' }}
          </button>
        </div>

      </form>

    </div>
  </div>
</div>


<!-- Modal de Categorías -->
<div
  *ngIf="modalCategorias"
  class="fixed inset-0 backdrop-blur-sm bg-black/50 flex items-center justify-center z-50 p-4"
>

  <div class="bg-white w-full max-w-4xl rounded-xl shadow-lg p-6 relative 
              max-h-[90vh] overflow-y-auto">

    <!-- Botón cerrar -->
    <button 
      (click)="cerrarModalCategorias()" 
      class="absolute top-3 right-3 text-gray-500 hover:text-black text-xl"
    >
      ✕
    </button>

    <h2 class="text-2xl font-semibold mb-6">
      Gestión de Categorías
    </h2>

    <!-- GRID HORIZONTAL -->
    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">

      <!-- ================= PANEL IZQUIERDO ================= -->
      <div class="rounded-xl border shadow-sm p-4 bg-gray-50 h-[60vh] overflow-y-auto">

        <h3 class="font-semibold text-lg mb-3">Lista de categorías</h3>

        <ul class="space-y-2">
          <li
            *ngFor="let c of categorias"
            class="bg-white px-3 py-2 rounded-md shadow flex justify-between items-center"
          >
            {{ c.nombre }}

            <div class="flex gap-3 text-xs">
              <button class="text-blue-600" (click)="editarCategoria(c)">Editar</button>
              <button class="text-red-600" (click)="eliminarCategoria(c.id_categoria)">Eliminar</button>
            </div>
          </li>
        </ul>

      </div>

      <!-- ================= PANEL DERECHO ================= -->
      <div class="rounded-xl border shadow-sm p-4 bg-white">

        <h3 class="font-semibold text-lg mb-4">
          {{ categoriaEditando ? "Editar categoría" : "Nueva categoría" }}
        </h3>

        <label class="block mb-2 font-medium">Nombre</label>

        <input
          [ngModel]="categoriaEditando ? categoriaEditando.nombre : nuevaCategoria"
          (ngModelChange)="categoriaEditando ? categoriaEditando.nombre = $event : nuevaCategoria = $event"
          type="text"
          class="w-full border rounded-lg px-3 py-2"
          (keypress)="soloLetras($event)"
        />

        <div class="flex justify-end mt-6 gap-3">
          <button 
            class="px-4 py-2 border rounded-lg hover:bg-gray-100" 
            (click)="cerrarModalCategorias()">
            Cancelar
          </button>

          <button 
            class="px-4 py-2 bg-[#0B1120] text-white rounded-lg hover:bg-[#141c33]"
            (click)="categoriaEditando ? guardarEdicionCategoria() : crearCategoria()"
          >
            Guardar
          </button>
        </div>

      </div>

    </div>

  </div>
</div>

<!-- Modal de Marcas -->
<div
  *ngIf="modalMarcas"
  class="fixed inset-0 backdrop-blur-sm bg-black/50 flex items-center justify-center z-50 p-4"
>

  <div class="bg-white w-full max-w-4xl rounded-xl shadow-lg p-6 relative 
              max-h-[90vh] overflow-y-auto">

    <!-- Botón cerrar -->
    <button 
      (click)="cerrarModalMarcas()" 
      class="absolute top-3 right-3 text-gray-500 hover:text-black text-xl"
    >
      ✕
    </button>

    <h2 class="text-2xl font-semibold mb-6">
      Gestión de Marcas
    </h2>

    <!-- GRID HORIZONTAL -->
    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">

      <!-- ================= PANEL IZQUIERDO ================= -->
      <div class="rounded-xl border shadow-sm p-4 bg-gray-50 h-[60vh] overflow-y-auto">

        <h3 class="font-semibold text-lg mb-3">Lista de marcas</h3>

        <ul class="space-y-2">
          <li
            *ngFor="let m of marcas"
            class="bg-white px-3 py-2 rounded-md shadow flex justify-between items-center"
          >
            {{ m.nombre }}

            <div class="flex gap-3 text-xs">
              <button class="text-blue-600" (click)="editarMarca(m)">Editar</button>
              <button class="text-red-600" (click)="eliminarMarca(m.id_marca)">Eliminar</button>
            </div>
          </li>
        </ul>

      </div>

      <!-- ================= PANEL DERECHO ================= -->
      <div class="rounded-xl border shadow-sm p-4 bg-white">

        <h3 class="font-semibold text-lg mb-4">
          {{ marcaEditando ? "Editar marca" : "Nueva marca" }}
        </h3>

        <label class="block mb-2 font-medium">Nombre</label>

        <input
          [ngModel]="marcaEditando ? marcaEditando.nombre : nuevaMarca"
          (ngModelChange)="marcaEditando ? marcaEditando.nombre = $event : nuevaMarca = $event"
          type="text"
          class="w-full border rounded-lg px-3 py-2"
          (keypress)="soloLetras($event)"
        />

        <div class="flex justify-end mt-6 gap-3">
          <button 
            class="px-4 py-2 border rounded-lg hover:bg-gray-100" 
            (click)="cerrarModalMarcas()">
            Cancelar
          </button>

          <button 
            class="px-4 py-2 bg-[#0B1120] text-white rounded-lg hover:bg-[#141c33]"
            (click)="marcaEditando ? guardarEdicionMarca() : crearMarca()"
          >
            Guardar
          </button>
        </div>

      </div>

    </div>

  </div>
</div>
