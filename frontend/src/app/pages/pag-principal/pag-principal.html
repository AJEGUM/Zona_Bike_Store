<app-nav-bar (searchChanged)="filtrarProductos($event)" [mensajeExterno]="mensajeToast"></app-nav-bar>
<div class=""> 
    <app-banner-promociones></app-banner-promociones>
</div>


<div [class.blur-xs]="modalAbierto" class="max-w-[1400px] mx-auto px-4 sm:px-6 lg:px-15 pt-10">
  <h2 class="text-2xl font-semibold mb-8 text-white">Nuestro CatÃ¡logo</h2>

  <!-- GRID -->
  <div *ngIf="productosFiltrados.length > 0; else noProductos" 
       class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-5">

    <!-- PRODUCTO -->
    <div *ngFor="let p of productosFiltrados" (click)="abrirModalProducto(p)"
         class="rounded-xl overflow-hidden cursor-pointer shadow border border-gray-600 bg-[#242938] flex flex-col group relative">

      <!-- IMAGEN -->
      <div class="h-60 sm:h-64 md:h-72 bg-gray-100 overflow-hidden relative">
        <img [src]="obtenerImagen(p)" alt="{{ p.nombre }}"
             class="w-full h-full object-cover sm:object-contain md:object-cover transform transition-transform duration-300 group-hover:scale-110" />

        <div class="absolute inset-0 flex items-center justify-center opacity-0 group-hover:opacity-100 transition-opacity duration-300 bg-black/30">
          <svg xmlns="http://www.w3.org/2000/svg" class="w-10 h-10 text-white" fill="currentColor" viewBox="0 0 24 24">
            <path d="M12 5c-7.633 0-11 7-11 7s3.367 7 11 7 11-7 11-7-3.367-7-11-7zm0 12c-2.761 0-5-2.239-5-5s2.239-5 5-5 5 2.239 5 5-2.239 5-5 5zm0-8.5c-1.93 0-3.5 1.57-3.5 3.5s1.57 3.5 3.5 3.5 3.5-1.57 3.5-3.5-1.57-3.5-3.5-3.5z" />
          </svg>
        </div>
      </div>

      <!-- INFO -->
      <div class="p-3 flex flex-col">
        <p class="text-[#6E5FD9] text-sm">{{ p.categoria?.nombre }}</p>
        <h3 class="text-lg mt-1 font-semibold text-white">{{ p.nombre }}</h3>
        <p class="text-gray-100 text-lg mt-2 font-semibold">{{ p.precio_venta_formateado }} COP</p>
        <p class="text-sm text-gray-100 mt-1">Stock: {{ p.stock || 0 }}</p>

        <!-- BOTÃ“N / MENSAJE -->
        <div class="mt-4">
          <!-- Mostrar solo si estÃ¡ activo -->
            <button *ngIf="p.estado === 'activo'" 
                    (click)="agregarAlCarrito(p, 1); $event.stopPropagation()"
                    class="bg-[#442ED9] text-white px-4 py-2 rounded-lg hover:bg-gray-900 w-full font-semibold">
            AÃ±adir al carrito
            </button>


          <!-- Mensaje si estÃ¡ inactivo -->
          <div *ngIf="p.estado !== 'activo'"
               class="w-full py-2 rounded-lg bg-[#2B3548] text-center text-gray-400 flex items-center justify-center gap-2 cursor-not-allowed">
            <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5 text-gray-300" fill="currentColor" viewBox="0 0 24 24">
              <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 18c-4.41 0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8zm-1-13h2v6h-2zm0 8h2v2h-2z" />
            </svg>
          No disponible
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- SIN PRODUCTOS -->
  <ng-template #noProductos>
    <div class="text-center text-gray-500 py-20 text-lg font-semibold">
      No se encontraron productos
    </div>
  </ng-template>
</div>

<!-- MODAL MEJORADO -->
<div *ngIf="modalAbierto" 
     class="fixed inset-0 bg-black/60 z-50 flex items-center justify-center p-4">
  
  <!-- Fondo clickeable para cerrar -->
  <div class="absolute inset-0" (click)="cerrarModalProducto()"></div>

  <!-- Contenedor del modal -->
  <div class="relative bg-[#242938] rounded-2xl shadow-2xl w-full max-w-4xl max-h-[90vh] overflow-hidden animate-fade-in z-10 flex flex-col">
    
    <!-- Header -->
    <div class="flex justify-between items-center px-6 py-4 border-b">
      <button (click)="cerrarModalProducto()"
              class="text-gray-400 hover:text-gray-700 text-2xl leading-none transition">
        &times;
      </button>
    </div>

    <!-- Contenido con scroll interno -->
    <div class="grid md:grid-cols-2 gap-0 flex-1 overflow-y-auto">
      
      <!-- Imagen -->
      <div class="bg-[#1A1D29] flex items-center justify-center p-6">
        <img [src]="obtenerImagen(modalProducto)" [alt]="modalProducto.nombre"
             class="w-full max-h-[450px] object-contain rounded-xl" />
      </div>

      <!-- InformaciÃ³n -->
      <div class="p-6 flex flex-col justify-between">
        <div>
          <h2 class="text-4xl text-center font-semibold text-gray-100 truncate">
            {{ modalProducto.nombre }}
          </h2>
          <p class="text-sm text-gray-300 mb-1 text-center">{{ modalProducto.categoria?.nombre }}</p>

          <p class="text-3xl font-semibold text-gray-100 mb-4">{{ modalProducto.precio_venta_formateado }} COP</p>          

          
          
          <h3 class="text-base font-semibold text-gray-300 mb-2">DescripciÃ³n:</h3>
          <p class="text-gray-300 leading-relaxed mb-6 whitespace-pre-line">{{ modalProducto.descripcion }}</p>
          
          <div class="flex items-center gap-2 mb-3">
            <span *ngIf="modalProducto.estado === 'activo'" 
                  class="bg-green-100 text-green-700 text-xs font-medium px-2 py-1 rounded">
              Disponible
            </span>
            <span *ngIf="modalProducto.estado !== 'activo'" 
                  class="bg-red-100 text-red-600 text-xs font-medium px-2 py-1 rounded">
              No disponible
            </span>
          </div>

          <div class="border-t pt-4 space-y-2 text-sm text-gray-300">
            <p>Stock disponible: <span class="font-medium">{{ modalProducto.stock || 0 }} unidades</span></p>
            <p>CategorÃ­a: <span class="font-medium">{{ modalProducto.categoria?.nombre }}</span></p>
          </div>
        </div>

        <!-- CONTROLES -->
        <div class="mt-6">
          <div class="flex items-center gap-3 mb-4" *ngIf="modalProducto.estado === 'activo'">
            <span class="text-sm text-gray-100 font-medium">Cantidad</span>
            <div class="flex items-center border rounded-lg">
              <button class="px-3 py-1 text-gray-100 rounded-l-lg" (click)="disminuirCantidad()">âˆ’</button>
              <input type="number"
                    [(ngModel)]="cantidad"
                    min="1"
                    class="w-12 text-center text-gray-100"
                    (input)="cantidad = +$event.target.value" />
              <button class="px-3 py-1 text-gray-100 rounded-r-lg" (click)="aumentarCantidad()">+</button>
            </div>
          </div>

          <button *ngIf="modalProducto.estado === 'activo'" 
                  (click)="agregarAlCarrito(modalProducto, cantidad); cerrarModalProducto()"
                  class="w-full bg-[#030213] text-white py-3 rounded-lg hover:bg-gray-900 font-medium flex items-center justify-center gap-2 transition">
            ðŸ›’ AÃ±adir al carrito
          </button>

          <div *ngIf="modalProducto.estado !== 'activo'"
               class="w-full py-3 bg-[#2B3548] text-center text-gray-300 rounded-lg flex items-center justify-center gap-2">
            ðŸš« Producto no disponible
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

