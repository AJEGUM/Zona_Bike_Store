<app-nav-bar (searchChanged)="filtrarProductos($event)" [mensajeExterno]="mensajeToast"></app-nav-bar>

<div [class.blur-xs]="modalAbierto" class="max-w-[1400px] mx-auto px-4 sm:px-6 lg:px-15">
  <h2 class="text-2xl font-semibold mb-8">Nuestro CatÃ¡logo</h2>

  <!-- GRID -->
  <div *ngIf="productosFiltrados.length > 0; else noProductos" 
       class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-5">

    <!-- PRODUCTO -->
    <div *ngFor="let p of productosFiltrados" (click)="abrirModalProducto(p)"
         class="rounded-xl overflow-hidden cursor-pointer shadow border border-gray-200 bg-white flex flex-col group relative">

      <!-- IMAGEN -->
      <div class="h-[320px] sm:h-[360px] md:h-[420px] bg-gray-100 overflow-hidden relative">
        <img [src]="obtenerImagen(p)" alt="{{ p.nombre }}"
             class="w-full h-full object-cover sm:object-contain md:object-cover transform transition-transform duration-300 group-hover:scale-110" />

        <div class="absolute inset-0 flex items-center justify-center opacity-0 group-hover:opacity-100 transition-opacity duration-300 bg-black/30">
          <svg xmlns="http://www.w3.org/2000/svg" class="w-10 h-10 text-white" fill="currentColor" viewBox="0 0 24 24">
            <path d="M12 5c-7.633 0-11 7-11 7s3.367 7 11 7 11-7 11-7-3.367-7-11-7zm0 12c-2.761 0-5-2.239-5-5s2.239-5 5-5 5 2.239 5 5-2.239 5-5 5zm0-8.5c-1.93 0-3.5 1.57-3.5 3.5s1.57 3.5 3.5 3.5 3.5-1.57 3.5-3.5-1.57-3.5-3.5-3.5z" />
          </svg>
        </div>
      </div>

      <!-- INFO -->
      <div class="p-5 flex flex-col">
        <p class="text-gray-500 text-sm">{{ p.categoria?.nombre }}</p>
        <h3 class="text-lg mt-1 font-semibold">{{ p.nombre }}</h3>
        <p class="text-gray-900 text-lg mt-2 font-bold">{{ p.precio_venta_formateado }} COP</p>
        <p class="text-sm text-gray-600 mt-1">Stock: {{ p.stock || 0 }}</p>

        <!-- BOTÃ“N / MENSAJE -->
        <div class="mt-4">
          <!-- Mostrar solo si estÃ¡ activo -->
            <button *ngIf="p.estado === 'activo'" 
                    (click)="agregarAlCarrito(p, 1); $event.stopPropagation()"
                    class="bg-[#030213] text-white px-4 py-2 rounded-lg hover:bg-gray-900 w-full">
            Agregar al carrito ðŸ›’
            </button>


          <!-- Mensaje si estÃ¡ inactivo -->
          <div *ngIf="p.estado !== 'activo'"
               class="w-full py-2 rounded-lg bg-gray-300 text-center text-gray-700 flex items-center justify-center gap-2 cursor-not-allowed">
            <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5 text-gray-600" fill="currentColor" viewBox="0 0 24 24">
              <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 18c-4.41 0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8zm-1-13h2v6h-2zm0 8h2v2h-2z" />
            </svg>
            Producto no disponible
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- SIN PRODUCTOS -->
  <ng-template #noProductos>
    <div class="text-center text-gray-500 py-20 text-lg font-semibold">
      No se encontraron productos
    </div>
  </ng-template>
</div>

<!-- MODAL -->
<div *ngIf="modalAbierto" class="fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4">
  <div class="bg-white rounded-2xl shadow-2xl max-w-5xl w-full overflow-hidden relative animate-fade-in">
    
    <button (click)="cerrarModalProducto()" class="absolute top-3 right-4 text-gray-400 hover:text-gray-700 text-2xl leading-none">&times;</button>

    <div class="grid md:grid-cols-2">
      <!-- Imagen -->
      <div class="bg-gray-100 flex items-center justify-center p-6">
        <img [src]="obtenerImagen(modalProducto)" [alt]="modalProducto.nombre"
             class="w-full max-h-[480px] object-contain rounded-xl" />
      </div>

      <!-- Info -->
      <div class="p-8 flex flex-col justify-between">
        <div>
          <p class="text-sm text-gray-500 mb-1">{{ modalProducto.categoria?.nombre }}</p>
          <h2 class="text-2xl font-semibold text-gray-900 mb-2">{{ modalProducto.nombre }}</h2>

          <span *ngIf="modalProducto.estado === 'activo'" 
                class="inline-block bg-green-100 text-green-700 text-xs font-medium px-2 py-1 rounded mb-4">
            Disponible
          </span>
          <span *ngIf="modalProducto.estado !== 'activo'" 
                class="inline-block bg-red-100 text-red-600 text-xs font-medium px-2 py-1 rounded mb-4">
            No disponible
          </span>

          <p class="text-3xl font-bold text-gray-900 mb-4">{{ modalProducto.precio_venta_formateado }} COP</p>

          <h3 class="text-base font-semibold text-gray-800 mb-2">DescripciÃ³n</h3>
          <p class="text-gray-600 leading-relaxed mb-6">{{ modalProducto.descripcion }}</p>

          <div class="border-t pt-4 space-y-2 text-sm text-gray-700">
            <p>Stock disponible: <span class="font-medium">{{ modalProducto.stock || 0 }} unidades</span></p>
            <p>CategorÃ­a: <span class="font-medium">{{ modalProducto.categoria?.nombre }}</span></p>
          </div>
        </div>

        <!-- CONTROLES -->
        <div class="mt-6">
          <div class="flex items-center gap-3 mb-4" *ngIf="modalProducto.estado === 'activo'">
            <span class="text-sm text-gray-700 font-medium">Cantidad</span>
            <div class="flex items-center border rounded-lg">
              <button class="px-3 py-1 text-gray-600 hover:bg-gray-100 rounded-l-lg" (click)="disminuirCantidad()">âˆ’</button>
                <input type="number"
                    [(ngModel)]="cantidad"
                    min="1"
                    class="w-12 text-center text-gray-800 border-x outline-none"
                    (input)="cantidad = +$event.target.value" />
              <button class="px-3 py-1 text-gray-600 hover:bg-gray-100 rounded-r-lg" (click)="aumentarCantidad()">+</button>
            </div>
          </div>

          <!-- Solo aparece si el producto estÃ¡ activo -->
          <button *ngIf="modalProducto.estado === 'activo'" 
                    (click)="agregarAlCarrito(modalProducto, cantidad); cerrarModalProducto()"
                  class="w-full bg-[#030213] text-white py-3 rounded-lg hover:bg-gray-900 font-medium flex items-center justify-center gap-2 transition">
            <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5" fill="none" viewBox="0 0 24 24"
                 stroke="currentColor" stroke-width="2">
              <path stroke-linecap="round" stroke-linejoin="round"
                    d="M3 3h2l.4 2M7 13h10l4-8H5.4M7 13l-2 9m12-9l2 9m-6-4a1 1 0 110-2 1 1 0 010 2z" />
            </svg>
            AÃ±adir al carrito
          </button>

          <!-- Aviso si estÃ¡ inactivo -->
          <div *ngIf="modalProducto.estado !== 'activo'"
               class="w-full py-3 bg-gray-300 text-center text-gray-700 rounded-lg flex items-center justify-center gap-2">
            <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5 text-gray-600" fill="currentColor" viewBox="0 0 24 24">
              <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 18c-4.41 0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8zm-1-13h2v6h-2zm0 8h2v2h-2z" />
            </svg>
            Producto no disponible
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
